{% extends 'core/base.html' %}

{% block title %}Bulk Meter Reading - Rental Management System{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <div class="border-4 border-dashed border-gray-200 rounded-lg p-6">
        <h1 class="text-2xl font-bold text-gray-900 mb-6">Bulk Meter Reading Entry</h1>
        
        <!-- Month Selector -->
        <div class="mb-6">
            <label for="month-selector" class="block text-sm font-medium text-gray-700 mb-2">Select Month</label>
            <input type="month" id="month-selector" class="form-input" value="{{ current_month|date:'Y-m' }}" onchange="loadReadings()">
        </div>

        <!-- Meter Readings Table -->
        <div class="bg-white shadow overflow-hidden sm:rounded-md">
            <form id="bulk-form" onsubmit="submitBulkReadings(event)">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Room</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Previous Reading</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Reading</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Units</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estimated Total</th>
                        </tr>
                    </thead>
                    <tbody id="readings-table" class="bg-white divide-y divide-gray-200">
                        {% for room in rooms %}
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                {{ room.room_number }} - {{ room.building.name }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" id="prev-{{ room.id }}">
                                {% if readings|lookup:room.id %}
                                    {{ readings|lookup:room.id.reading_value }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <input type="number" 
                                       step="0.01" 
                                       min="0" 
                                       class="form-input w-32 current-reading" 
                                       data-room-id="{{ room.id }}"
                                       data-previous="{% if readings|lookup:room.id %}{{ readings|lookup:room.id.reading_value }}{% else %}0{% endif %}"
                                       onchange="calculateUnits({{ room.id }})"
                                       placeholder="Enter reading">
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" id="units-{{ room.id }}">
                                0
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" id="total-{{ room.id }}">
                                ₹0
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                
                <div class="px-6 py-4 bg-gray-50 border-t border-gray-200">
                    <button type="submit" class="btn-primary">Preview & Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Get electricity rate (you might want to fetch this from API)
const ELECTRICITY_RATE = 10.50; // This should be fetched from settings

function calculateUnits(roomId) {
    const input = document.querySelector(`input[data-room-id="${roomId}"]`);
    const previousReading = parseFloat(input.dataset.previous) || 0;
    const currentReading = parseFloat(input.value) || 0;
    
    const units = Math.max(0, currentReading - previousReading);
    const total = units * ELECTRICITY_RATE;
    
    document.getElementById(`units-${roomId}`).textContent = units.toFixed(2);
    document.getElementById(`total-${roomId}`).textContent = `₹${total.toFixed(2)}`;
}

function loadReadings() {
    const month = document.getElementById('month-selector').value;
    // Reload page with new month parameter
    window.location.href = `{% url 'meter_bulk' %}?month=${month}`;
}

function submitBulkReadings(event) {
    event.preventDefault();
    
    const readings = [];
    const month = document.getElementById('month-selector').value;
    
    document.querySelectorAll('.current-reading').forEach(input => {
        if (input.value) {
            readings.push({
                room_id: parseInt(input.dataset.roomId),
                reading_date: `${month}-15`, // Use 15th of the month
                reading_value: parseFloat(input.value)
            });
        }
    });
    
    if (readings.length === 0) {
        alert('Please enter at least one reading');
        return;
    }
    
    // Submit to API
    fetch('/api/meter/readings/bulk/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(readings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.errors && data.errors.length > 0) {
            alert('Some readings could not be saved. Please check the errors.');
            console.error(data.errors);
        } else {
            alert(`Successfully saved ${data.created} readings`);
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while saving readings');
    });
}
</script>
{% endblock %}
